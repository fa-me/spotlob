# test:
#   image: $CI_REGISTRY/fmeyer/spotlob:latest
#   stage: test
#   tags:
#     - asprunner
#   script:
#     - source activate spotlob-env
#     - pytest --cov spotlob

build package:
  image: python:3.7
  stage: build
  tags:
    - asprunner
  artifacts:
    name: "$CI_COMMIT_REF_NAME"
    paths:
    - dist/
    expire_in: 1 week
  script:
    - pip install -r requirements-dev.txt
    - python setup.py sdist

test tox:
  image: python:3.7
  stage: test
  tags:
    - asprunner
  script:
    - pip install pytest tox
    - tox

test pip:
  image: python:3.7
  stage: test
  tags:
    - asprunner
  script:
    - pip install -r requirements.txt
    - pip install pytest pytest-cov
    - pytest --cov spotlob

test notebooks:
  image: python:3.7
  stage: test
  tags:
    - asprunner
  script:
    - pip install -r requirements.txt
    - pip install pytest pytest-cov nbval
    - pytest --nbval ./notebooks

build doc:
  image: python:3.7
  stage: deploy
  tags:
    - asprunner
  artifacts:
    name: "$CI_COMMIT_REF_NAME"
    paths:
    - docs/_build/html/
    expire_in: 1 week
  script:
    - apt-get update
    - apt-get install graphviz -y
    - pip install -r requirements-dev.txt
    - cd docs
    - mkdir _static
    - sphinx-build -W -b html -d _build/doctrees . _build/html
    #- make html

build image:
  image: docker:stable
  stage: deploy
  only:
    refs:
      - master
    changes:
      - dockerfile
      - requirements.yml
  tags:
    - asprunner
  script:
    - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
    - docker build -t $CI_REGISTRY/fmeyer/spotlob .
    - docker push $CI_REGISTRY/fmeyer/spotlob
